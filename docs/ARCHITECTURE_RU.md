# Документация по архитектуре TRNS

## Обзор

TRNS — система транскрипции и обработки языковыми моделями, поддерживающая несколько источников ввода (YouTube, Twitter/X.com, локальные файлы) и предоставляющая интерфейсы CLI и Telegram-бота.

## Архитектура системы

```
┌─────────────────────────────────────────────────────────────┐
│                    Пользовательский интерфейс                │
├──────────────────────┬──────────────────────────────────────┤
│   CLI интерфейс       │   Интерфейс Telegram-бота            │
│   (команда trns)     │   (FastAPI Webhook сервер)            │
└──────────┬───────────┴──────────────┬───────────────────────┘
           │                          │
           └──────────┬───────────────┘
                      │
        ┌─────────────▼─────────────┐
        │   Пайплайн транскрипции   │
        │   (Слой оркестрации)      │
        └─────────────┬─────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
┌───────▼──────┐ ┌───▼──────┐ ┌───▼──────────┐
│  Извлечение  │ │ Whisper  │ │  Языковая   │
│    аудио     │ │Транскрибер│ │   модель    │
│  (yt-dlp)    │ │           │ │  процессор  │
└──────────────┘ └───────────┘ └─────────────┘
```

## Обзор компонентов

### 1. CLI интерфейс (`trns.cli.main`)

**Назначение:** Точка входа командной строки для транскрипции

**Точка входа:** `trns <url>`

**Поток:**
1. Парсинг аргументов командной строки
2. Инициализация пайплайна транскрипции
3. Обработка видео/аудио
4. Вывод транскрипции в stdout

**Ключевые файлы:**
- `src/trns/cli/main.py` - Точка входа CLI
- `src/trns/transcription/main.py` - Основная логика транскрипции

### 2. Интерфейс Telegram-бота (`trns.bot`)

**Назначение:** Интерактивный Telegram-бот для транскрипции

**Архитектура:**
- **FastAPI сервер** (`trns.bot.server`): Webhook сервер
- **Обработчики маршрутов** (`trns.bot.routes`): Обработчики сообщений и команд
- **Утилиты** (`trns.bot.utils`): Аутентификация, управление токенами, конфигурация
- **Обработчик вывода** (`trns.bot.output_handler`): Отправка сообщений в реальном времени

**Поток:**
1. Пользователь отправляет сообщение (URL, видеофайл или команду)
2. FastAPI получает webhook-обновление
3. Обработчик маршрута обрабатывает сообщение
4. Пайплайн транскрипции запускается в фоновом потоке
5. Вывод отправляется в Telegram через систему очередей

**Ключевые функции:**
- На основе webhooks (без polling)
- Обновления транскрипции в реальном времени (каждые interval секунд)
- Аутентификация
- Поддержка нескольких пользователей

### 3. Пайплайн транскрипции (`trns.transcription.pipeline`)

**Назначение:** Оркестрирует весь процесс транскрипции

**Компоненты:**
- **Извлекатель субтитров** (`subtitle_extractor.py`): Извлекает автоматически сгенерированные субтитры
- **Whisper транскрибер** (`whisper_transcriber.py`): Преобразование речи в текст с помощью Whisper
- **Процессор языковой модели** (`language_model.py`): Обрабатывает транскрипции через LM

**Поток пайплайна:**

```
Вход (URL/Файл)
    │
    ├─► Извлечение аудио (yt-dlp/FFmpeg)
    │
    ├─► Попытка субтитров (если доступны)
    │   └─► Извлекатель субтитров YouTube
    │
    ├─► Резервный вариант Whisper (если нет субтитров)
    │   └─► Whisper транскрибер
    │       ├─► Определение языка
    │       └─► Транскрипция
    │
    ├─► Перевод (если не русский)
    │   └─► Deep Translator
    │
    └─► Обработка языковой моделью
        └─► OpenRouter.ai API
            └─► Генерация отчета
```

**Режимы обработки:**
- **Авто**: Сначала попытка субтитров, затем Whisper
- **Только субтитры**: Только автоматически сгенерированные субтитры
- **Только Whisper**: Только преобразование речи в текст

### 4. Извлечение аудио (`trns.transcription.whisper_transcriber`)

**Назначение:** Извлечение аудио из различных источников

**Поддерживаемые источники:**
- Видео YouTube (через yt-dlp)
- Видео Twitter/X.com (через yt-dlp)
- Локальные видеофайлы (через FFmpeg)

**Процесс:**
1. Загрузка/извлечение видео
2. Извлечение аудиодорожки
3. Конвертация в формат, подходящий для Whisper
4. Возврат пути к аудиофайлу

### 5. Транскрипция Whisper (`trns.transcription.whisper_transcriber`)

**Назначение:** Преобразование речи в текст

**Функции:**
- Автоматическое определение языка
- Выбор размера модели на основе языка
- Обработка по частям для длинных видео
- Обработка перекрытий для предотвращения потери текста

**Модели:**
- Использует `faster-whisper` для эффективной обработки
- Поддерживает несколько размеров моделей (tiny, base, small, medium, large)

### 6. Обработка языковой моделью (`trns.transcription.language_model`)

**Назначение:** Обработка транскрипций через языковую модель для сводок/отчетов

**Провайдер:** OpenRouter.ai

**Функции:**
- Отслеживание дневной емкости (1000 запросов/день)
- Автоматический сброс емкости в полночь UTC
- Управление токенами
- Обработка ошибок с повторными попытками

**Процесс:**
1. Сбор частей транскрипции
2. Отправка в OpenRouter.ai API
3. Получение обработанного отчета
4. Возврат форматированного вывода

## Поток данных

### Поток CLI

```
Пользователь: trns <url>
    │
    ├─► Парсинг аргументов
    ├─► Инициализация пайплайна
    ├─► Обработка видео
    │   ├─► Извлечение аудио
    │   ├─► Транскрипция
    │   ├─► Перевод
    │   └─► Обработка LM
    └─► Вывод в stdout
```

### Поток Telegram-бота

```
Пользователь отправляет сообщение
    │
    ├─► Telegram API
    ├─► Webhook → FastAPI
    ├─► Обработчик маршрута
    │   ├─► Проверка аутентификации
    │   ├─► Проверка емкости
    │   └─► Запуск обработки (асинхронно)
    │
    ├─► Фоновый поток
    │   ├─► Пайплайн транскрипции
    │   │   ├─► Извлечение аудио
    │   │   ├─► Транскрипция
    │   │   ├─► Перевод
    │   │   └─► Обработка LM
    │   │
    │   └─► Очередь вывода
    │       └─► Отправка в Telegram (в реальном времени)
    │
    └─► Пользователь получает обновления
```

## Управление конфигурацией

### Переменные окружения (Приоритет 1)

- `BOT_TOKEN`: Токен Telegram-бота
- `AUTH_KEY`: Ключ аутентификации
- `OPENROUTER_API_KEY`: API ключ для обработки LM
- `ALLOWED_USER_IDS`: ID пользователей через запятую
- `HOST`, `PORT`: Конфигурация сервера
- `CONFIG_PATH`, `METADATA_PATH`: Пути к файлам

### Файловая конфигурация (Приоритет 2)

- `bot_key.txt`: Токен бота
- `key.txt`: Ключ аутентификации
- `api_key.txt`: API ключи (по одному на строку)
- `allowed_ids.txt`: ID пользователей (по одному на строку)
- `config.json`: Конфигурация приложения
- `metadata.json`: Локализация

## Управление состоянием

### Состояния пользователя (Telegram-бот)

- `waiting_key`: Пользователю нужно пройти аутентификацию
- `waiting_context`: Пользователь устанавливает контекст
- `processing`: У пользователя активная транскрипция

### Состояния обработки

- Отслеживание задач в памяти для каждого пользователя
- Потокобезопасные блокировки для параллельного доступа
- Поддержка корректного завершения

## Модель потоков

### Telegram-бот

- **Основной поток**: FastAPI/uvicorn сервер
- **Фоновые потоки**: Обработка транскрипции для каждого пользователя
- **Поток вывода**: Отправка сообщений на основе очереди

### Пайплайн транскрипции

- **Основной поток**: Оркестрация
- **Поток транскрипции**: Обработка аудио
- **Поток LM**: Обработка языковой моделью

## Обработка ошибок

### Уровни

1. **Для пользователя**: Дружелюбные сообщения об ошибках через Telegram
2. **Логирование**: Подробные ошибки в логах
3. **Повторные попытки**: Автоматические повторы для API вызовов
4. **Корректная деградация**: Резервные методы (субтитры → Whisper)

### Типы ошибок

- **Ошибки аутентификации**: Пользователь не авторизован
- **Ошибки емкости**: Превышен дневной лимит
- **Ошибки транскрипции**: Сбои извлечения/обработки аудио
- **Ошибки API**: Сбои OpenRouter.ai (с повторными попытками)

## Безопасность

### Аутентификация

- Файловые или переменные окружения ключи аутентификации
- Белый список ID пользователей
- Проверка аутентификации на каждый запрос

### Управление токенами

- Безопасное хранение токенов (файлы или переменные окружения)
- Дневные лимиты емкости
- Автоматический сброс в полночь UTC

## Соображения масштабируемости

### Текущие ограничения

- Состояние в памяти (не подходит для нескольких экземпляров)
- Однопоточная обработка на пользователя
- Файловая конфигурация

### Будущие улучшения

- Интеграция с базой данных: Постоянное состояние пользователя
- Кэширование: Redis для информации о видео
- Система очередей: Celery для фоновых задач
- Поддержка горизонтального масштабирования

## Зависимости

### Основные

- `youtube-transcript-api`: Извлечение субтитров
- `yt-dlp`: Загрузка видео/аудио
- `faster-whisper`: Преобразование речи в текст
- `deep-translator`: Перевод
- `openai`: Клиент OpenRouter.ai

### Бот

- `python-telegram-bot`: Telegram API
- `fastapi`: Webhook сервер
- `uvicorn`: ASGI сервер

### Утилиты

- `python-dotenv`: Переменные окружения
- `pydantic`: Валидация конфигурации
- `tqdm`: Индикаторы прогресса

## Архитектура развертывания

### Рекомендуется: Yandex Serverless Containers

```
Интернет
    │
    ├─► Telegram API
    │   └─► Webhook → Yandex Serverless Container
    │       ├─► FastAPI сервер
    │       ├─► Обработчики маршрутов
    │       └─► Фоновая обработка
    │
    └─► Пользователь (CLI)
        └─► Локальная установка
```

### Альтернатива: Развертывание на VM

```
VM (Yandex Compute Cloud)
    │
    ├─► Nginx (Обратный прокси)
    ├─► Systemd сервис
    │   └─► FastAPI сервер
    └─► Файловая система
        └─► Файлы конфигурации
```

## Характеристики производительности

### Скорость транскрипции

- **Субтитры**: ~1-2 секунды (мгновенно)
- **Whisper (base)**: ~0.5-1x реального времени
- **Whisper (large)**: ~0.1-0.3x реального времени

### Использование ресурсов

- **Память**: 2-4GB (в зависимости от размера модели)
- **CPU**: Высокое во время транскрипции
- **Диск**: Временные аудиофайлы

### Узкие места

1. Извлечение аудио (сетевой/дисковый I/O)
2. Транскрипция Whisper (интенсивная по CPU)
3. Обработка LM (задержка API)

## Мониторинг

### Проверки здоровья

- Эндпоинт `/health` для здоровья контейнера
- Проверка статуса бота
- Мониторинг емкости

### Логирование

- Структурированное логирование (формат JSON для облака)
- Уровни логов: INFO, WARNING, ERROR
- Логирование запросов/ответов

## Будущие улучшения

1. **Интеграция с базой данных**: Постоянное состояние пользователя
2. **Кэширование**: Redis для информации о видео
3. **Система очередей**: Celery для фоновых задач
4. **Поддержка нескольких языков**: Больше языков в метаданных
5. **Админ-интерфейс**: Веб-панель управления
6. **Аналитика**: Статистика использования

